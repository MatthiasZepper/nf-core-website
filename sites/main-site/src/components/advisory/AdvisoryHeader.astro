---
import LocalDateTime from "@components/event/LocalDateTime.svelte";
import { advisories_type_classes, advisories_type_icons } from "./advisoryUtils";
import GitHubProfilePictureExtended from "@components/GitHubProfilePictureExtended.svelte";
import {
    formatAdvisoryType,
    formatAdvisoryCategory,
    advisory_classes,
    advisory_icons,
    getAdvisoryMetadataItems,
} from "./advisoryUtils";

interface Props {
    frontmatter: {
        publishedDate: Date;
        severity: string;
        type: string[];
        category: string[];
        reporter: Array<string | Record<string, string>> | null;
        reviewer?: Array<string | Record<string, string>>;
        nextflowVersions?: string[] | null;
        nextflowExecutors?: string[] | null;
        softwareDependencies?: Array<string | { name: string; versions?: string[] }> | string | null;
    };
}

const { frontmatter } = Astro.props;
const metadataItems = getAdvisoryMetadataItems(frontmatter);

function getReporterInfo(reporter: string | Record<string, string>) {
    if (typeof reporter === "string") {
        return { username: reporter, affiliation: "" };
    }
    return { username: Object.keys(reporter)[0], affiliation: Object.values(reporter)[0] };
}

function getReviewerInfo(reviewer: string | Record<string, string>) {
    if (typeof reviewer === "string") {
        return { username: reviewer, affiliation: "" };
    }
    return { username: Object.keys(reviewer)[0], affiliation: Object.values(reviewer)[0] };
}

const hasContributors = frontmatter.reporter?.length || frontmatter.reviewer?.length;
---

<div class="advisory-header">
    <h2 class="h4 pt-2 pb-2 mb-4 border-top border-bottom">Categorisation</h2>
    <div class="d-flex flex-column gap-2">
        <div>
            <dl class="mb-0">
                <dt class="fw-semibold mb-1 text-body-secondary">Published</dt>
                <dd class="mb-4">{frontmatter.publishedDate.toLocaleDateString()}</dd>

                <dt class="fw-semibold mb-1 text-body-secondary">Severity</dt>
                <dd class="mb-4">
                    <span class={`badge bg-${advisory_classes[frontmatter.severity] || "secondary"}`}>
                        <i class={`${advisory_icons[frontmatter.severity] || "fa-circle-info"} me-1`}></i>
                        {formatAdvisoryCategory(frontmatter.severity)}
                    </span>
                </dd>

                <dt class="fw-semibold mb-1 text-body-secondary">Type</dt>
                <dd class="mb-4">
                    {
                        frontmatter.type.map((type) => (
                            <span class={`badge bg-${advisory_classes[type] || "secondary"} me-1`}>
                                <i class={`${advisory_icons[type] || "fa-circle-info"} me-1`} />
                                {formatAdvisoryType(type)}
                            </span>
                        ))
                    }
                </dd>

                <dt class="fw-semibold mb-1 text-body-secondary">Category</dt>
                <dd class="mb-4">
                    {
                        frontmatter.category.map((cat) => (
                            <span class="d-inline-flex align-items-center me-3 fw-light small mt-1">
                                <i class={`${advisory_icons[cat] || "fa-solid fa-cogs"} me-1 text-primary`} />
                                {formatAdvisoryCategory(cat)}
                            </span>
                        ))
                    }
                </dd>

                {
                    metadataItems.length > 0 && (
                        <>
                            <dt class="fw-semibold mb-1 text-body-secondary">Technical Details</dt>
                            <dd class="mb-4">
                                {metadataItems.map((item) => (
                                    <div class="mb-2">
                                        <div class="fw-semibold small mb-1">
                                            {item.iconType === "fa" ? (
                                                <i class={`fas ${item.icon} me-1 text-primary`} />
                                            ) : (
                                                <span class="me-1 text-primary" set:html={item.icon} />
                                            )}
                                            {item.label}
                                        </div>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="fw-light small">{item.value}</span>
                                        </div>
                                    </div>
                                ))}
                            </dd>
                        </>
                    )
                }
            </dl>
        </div>

        {
            hasContributors && (
                <div>
                    <h2 class="h4 pt-2 pb-2 mb-4 border-top border-bottom">Contributors</h2>
                    {frontmatter.reporter && (
                        <div class="mb-2">
                            <dt class="fw-semibold mb-2 text-body-secondary">Reported by</dt>
                            <dd class="d-flex flex-wrap gap-2 mb-0">
                                {frontmatter.reporter.map((reporter) => {
                                    const info = getReporterInfo(reporter);
                                    return (
                                        <div>
                                            <GitHubProfilePictureExtended
                                                client:load
                                                username={info.username}
                                                affiliation={info.affiliation}
                                                size={45}
                                                wrapperClasses="advisory-profile"
                                                labelClasses="d-none"
                                            />
                                        </div>
                                    );
                                })}
                            </dd>
                        </div>
                    )}
                    {frontmatter.reviewer && (
                        <div>
                            <dt class="fw-semibold mb-2 text-body-secondary">Reviewed by</dt>
                            <dd class="d-flex flex-wrap gap-2 mb-0">
                                {frontmatter.reviewer.map((reviewer) => {
                                    const info = getReviewerInfo(reviewer);
                                    return (
                                        <div>
                                            <GitHubProfilePictureExtended
                                                client:load
                                                username={info.username}
                                                affiliation={info.affiliation}
                                                size={45}
                                                wrapperClasses="advisory-profile"
                                                labelClasses="d-none"
                                            />
                                        </div>
                                    );
                                })}
                            </dd>
                        </div>
                    )}
                </div>
            )
        }
    </div>
</div>

<style lang="scss">
    .advisory-header {
        .badge {
            font-size: 0.875rem;
            padding: 0.35em 0.65em;
            font-weight: 500;
        }

        :global(.advisory-profile) {
            .btn {
                padding: 0;
                border: none;
                background: none;

                &:hover {
                    transform: scale(1.05);
                    transition: transform 0.2s ease-in-out;
                }
            }

            img {
                border-radius: 50%;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
    }
</style>
